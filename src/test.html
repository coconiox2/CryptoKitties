<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>test</title>
<script src="js/BigInt.js"></script>
<script src="js/Calculator.min.js"></script>
<script type="text/javascript">

function isPrinme(n){
        if(n == 0 || n==1){
            return 0;
        }else if(n==2){
            return 1;
        }else if(n % 2 == 0){
            return 0;
        }
        for(var i=3;i<Math.sqrt(n);i=i+2){
            if(n%i == 0){
                return 0;
            }
        }
        return 1;
    }

function generateRandomPrinme(){
        var randomInt10;
        while(1){
            randomInt10 = Math.floor((Math.random()+Math.floor(Math.random()*9+1))*Math.pow(1,1));
            if(isPrinme(randomInt10)){
                break;
            }
        }
        return randomInt10;
    }

function calMod(a, b) {
	var cal = new Calculator();
    var c = cal.divide(a,b,0);
    var d = cal.multiply(b,c);
    var e = cal.minus(a,d);
    return e;
}

function calGcd(a, b) {

    return (b == "0" || b==0)? a:calGcd(b,calMod(a,b));
}

function strAddBlank(str){
        var result = [];
        var list = str.split("");
       /* for(var i=0;i<list.length;i++){
            if(i != 0){
                result.push(" ");
            }
            var item = list[i];
            var octalStr = parseInt(item);
            result.push(octalStr);
        }*/   
        return list.join(" ");
    }

function keyGeneration(){
        var cal = new Calculator();

        var key = new Array();
        var p = generateRandomPrinme();
        var q = generateRandomPrinme();
        var pStr = p.toString();
        var qStr = q.toString();
        //////////[n,g]:public key
        var n = cal.multiply(pStr,qStr);
        var nsquare = cal.multiply(n,n);
        var g = 2;

        //var g = Math.floor((Math.random()*100))+1;
        //////////lambda:private key
        //lamada=lcm(p-1,q-1),即lamada是p-1,q-1的最小公倍数
        //lamada=((p-1)*(q-1)) / gcd(p-1,q-1);
        //var lambda = bigDiv(bigMul(bigSub(pStr,1),bigSub(qStr,1)),bigGcd(bigSub(pStr,1),bigSub(qStr,1)));
        var chushu = calGcd(cal.minus(pStr,"1"),cal.minus(qStr,"1"));
        var beichushu = cal.multiply(cal.minus(pStr,"1"),cal.minus(qStr,"1"));
        var lambda = cal.divide(beichushu,chushu);
        key[0] = n.toString();
        key[1] = g.toString();
        key[2] = lambda.toString();
        return key.join(" ");
    }

function encryptFile(_fileContent,_pubKey){
        var key = new Array();
        var cal = new Calculator();
        key = _pubKey.split(" ");
        var N = key[0];
        var g = key[1];
        var r = Math.floor((Math.random()*100));
        //encrypt
        //pri = (g^m)*(r^n)modnsquare
        var a = cal.power(g,_fileContent);
        var b = cal.power(r,N);
        var c = cal.multiply(N,N);
        
        var d = cal.multiply(a,b);
        var e = calMod(d,c);
        return e;
    }

function decryptFile(_fileContent,_priKey,_pubKey){
        var key = new Array();
        var cal = new Calculator();
        key = _pubKey.split(" ");
        var N = key[0];
        var g = key[1];
        var nsquare = cal.multiply(N,N);

        //decrypt
        var a1 = cal.power(_fileContent,_priKey);
        var b1 = calMod(a1,nsquare);
        var c1 = cal.divide(cal.minus(b1,1),N);

        var a2 = cal.power(g,_priKey);
        var b2 = calMod(a2,nsquare);
        var c2 = cal.divide(cal.minus(b2,1),N);

        var d = cal.divide(c1,c2);
        var e = calMod(d,N);
        return e;
    }


var a = keyGeneration();
var b = a.split(" ");
var c = new Array();
c[0] = b[0];
c[1] = b[1];

var priKey = b[2];
var pubkey = c.join(" ");

var file = "5";
var test = encryptFile(file,pubkey);
var tes = decryptFile(test,priKey,pubkey);


</script>
</head>
<body>
</body>
</html>
